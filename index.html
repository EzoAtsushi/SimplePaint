<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Simple MEMO</title>
  <link rel="manifest" href="./manifest.webmanifest" />
  <meta name="theme-color" content="#f3f4f6" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <link rel="apple-touch-icon" href="./apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="./favicon-32.png" />

  <style>
    :root{
      --bg:#ffffff;
      --ui:#f3f4f6;
      --ui2:#e5e7eb;
      --text:#111827;
      --accent:#2563eb;
      --shadow: 0 6px 18px rgba(0,0,0,.10);
    }
    html,body{height:100%; margin:0; background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, "Hiragino Sans", "Noto Sans JP", sans-serif;}
    body{overflow:hidden; touch-action:none; overscroll-behavior:none; -webkit-overflow-scrolling:auto;}
    .wrap{
      position:fixed; inset:0;
      display:flex; flex-direction:column;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
      box-sizing:border-box;
    }
    .toolbar{
      display:flex; gap:10px; align-items:center;
      padding:10px;
      background:var(--ui);
      border-bottom:1px solid var(--ui2);
      box-shadow: var(--shadow);
      z-index:2;
    }
    .btn{
      appearance:none; border:1px solid var(--ui2);
      background:#fff; color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      font-size:16px;
      line-height:1;
      min-width:48px;
      min-height:44px;
      display:flex; align-items:center; justify-content:center;
      user-select:none;
    }
    .btn[aria-pressed="true"]{
      border-color: var(--accent);
      outline: 2px solid rgba(37,99,235,.25);
    }
    .dot{
      width:22px; height:22px; border-radius:999px;
      border:1px solid rgba(0,0,0,.15);
      box-sizing:border-box;
    }
    .line{
      display:block;
      width:26px;
      border-top:3px solid var(--text);
      border-radius:999px;
    }
    .btn.size[data-size="7"] .line{ border-top-width:7px; }
    .color-wrap{
      position:relative;
      display:flex;
      align-items:center;
    }
    .palette{
      position:absolute;
      top:calc(100% + 8px);
      left:0;
      display:none;
      gap:10px;
      padding:10px;
      background:var(--ui);
      border:1px solid var(--ui2);
      border-radius:16px;
      box-shadow: var(--shadow);
      z-index:5;
    }
    .palette.show{ display:flex; }
    .btn.sub-color{
      min-width:44px;
      min-height:44px;
      padding:10px;
    }
    .spacer{flex:1;}
    .hint{
      font-size:12px; opacity:.75;
      white-space:nowrap;
    }
    #canvas{
      flex:1;
      width:100%;
      height:100%;
      display:block;
      background:#fff;
      touch-action:none;
    }
  
    /* iPad + Apple Pencil: 長押しの選択メニューやコールアウトを出しにくくする */
    *{-webkit-tap-highlight-color: transparent;}
    html,body{-webkit-user-select:none; user-select:none; -webkit-touch-callout:none;}
    #canvas{-webkit-user-select:none; user-select:none; -webkit-touch-callout:none;}

  
    /* iPad + Apple Pencil: 選択メニュー（コピー等）を出しにくくする */
    *{
      -webkit-tap-highlight-color: transparent;
      -webkit-user-select:none;
      user-select:none;
      -webkit-touch-callout:none;
    }

  </style>
</head>
<body>
  <div class="wrap">
    <div class="toolbar">
      <button class="btn color main-color" data-color="#111827" aria-pressed="true" title="黒">
        <span class="dot" style="background:#111827"></span>
      </button>
      <button class="btn color main-color" data-color="#ffffff" aria-pressed="false" title="白">
        <span class="dot" style="background:#ffffff"></span>
      </button>

      <div class="color-wrap" id="multiWrap">
        <button class="btn color main-color" id="multiBtn" aria-pressed="false" title="青（赤/黄/緑）">
          <span class="dot" id="multiDot" style="background:#2563eb"></span>
        </button>
        <div class="palette" id="multiPalette" aria-label="色を選択">
          <button class="btn sub-color" data-color="#2563eb" aria-pressed="true" title="青"><span class="dot" style="background:#2563eb"></span></button>
          <button class="btn sub-color" data-color="#ef4444" aria-pressed="false" title="赤"><span class="dot" style="background:#ef4444"></span></button>
          <button class="btn sub-color" data-color="#f59e0b" aria-pressed="false" title="黄"><span class="dot" style="background:#f59e0b"></span></button>
          <button class="btn sub-color" data-color="#22c55e" aria-pressed="false" title="緑"><span class="dot" style="background:#22c55e"></span></button>
        </div>
      </div>

      <button class="btn size" data-size="3" aria-pressed="true" title="細"><span class="line" aria-hidden="true"></span></button>
      <button class="btn size" data-size="7" aria-pressed="false" title="太"><span class="line" aria-hidden="true"></span></button>
      <div class="spacer"></div>

      <button class="btn" id="clearBtn" title="全消し">全消し</button>
    </div>

    <canvas id="canvas"></canvas>
  </div>

<script>
(() => {
  // iPad: テキスト選択が発生したら即解除
  document.addEventListener('selectionchange', () => {
    const sel = document.getSelection?.();
    if (sel && sel.type === 'Range') sel.removeAllRanges();
  });
  // ピンチ/回転などのジェスチャー抑制
  document.addEventListener('gesturestart', (e) => e.preventDefault(), { passive:false });
  document.addEventListener('gesturechange', (e) => e.preventDefault(), { passive:false });
  document.addEventListener('gestureend', (e) => e.preventDefault(), { passive:false });

  document.onselectstart = () => false;

  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d', { alpha: false });
  let dpr = Math.max(1, window.devicePixelRatio || 1);

  let penColor = '#111827';
  let penSize = 3;

  let drawing = false;
  let activePointerId = null;
  let lastX = 0, lastY = 0;

  function cssSize() {
    const rect = canvas.getBoundingClientRect();
    return { w: rect.width, h: rect.height };
  }

  function resizeCanvas(keep = true) {
    const prev = document.createElement('canvas');
    let prevW = canvas.width, prevH = canvas.height;

    if (keep && prevW && prevH) {
      prev.width = prevW;
      prev.height = prevH;
      prev.getContext('2d').drawImage(canvas, 0, 0);
    }

    dpr = Math.max(1, window.devicePixelRatio || 1);
    const { w, h } = cssSize();
    canvas.width = Math.floor(w * dpr);
    canvas.height = Math.floor(h * dpr);

    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';

    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, w, h);

    if (keep && prevW && prevH) {
      const prevCssW = prevW / dpr;
      const prevCssH = prevH / dpr;
      ctx.drawImage(prev, 0, 0, prevCssW, prevCssH);
    }
  }

  function setActive(groupSelector, activeBtn) {
    document.querySelectorAll(groupSelector).forEach(b => b.setAttribute('aria-pressed', 'false'));
    activeBtn.setAttribute('aria-pressed', 'true');
  }

  // 色（メイン: 黒/白/青） + 青を押したときの4色パレット（青/赤/黄/緑）
  const mainColorBtns = document.querySelectorAll('.btn.color.main-color');
  const multiWrap = document.getElementById('multiWrap');
  const multiBtn = document.getElementById('multiBtn');
  const multiDot = document.getElementById('multiDot');
  const palette = document.getElementById('multiPalette');
  const subBtns = document.querySelectorAll('.btn.sub-color');

  let multiColor = '#2563eb'; // パレット側の現在色（初期: 青）

  function setMainActive(btn) {
    mainColorBtns.forEach(b => b.setAttribute('aria-pressed', 'false'));
    btn.setAttribute('aria-pressed', 'true');
  }

  function showPalette() { if (palette) palette.classList.add('show'); }
  function hidePalette() { if (palette) palette.classList.remove('show'); }

  function updateSubActive() {
    subBtns.forEach(b => b.setAttribute('aria-pressed', (b.dataset.color === multiColor) ? 'true' : 'false'));
    if (multiDot) multiDot.style.background = multiColor;
  }

  // 黒/白
  document.querySelectorAll('.btn.color.main-color').forEach(btn => {
    if (btn.id === 'multiBtn') return;
    btn.addEventListener('click', () => {
      penColor = btn.dataset.color;
      setMainActive(btn);
      hidePalette();
    });
  });

  // 青（= パレット入口）
  if (multiBtn) {
    multiBtn.addEventListener('click', () => {
      setMainActive(multiBtn);
      penColor = multiColor;
      updateSubActive();
      if (palette && palette.classList.contains('show')) hidePalette();
      else showPalette();
    });
  }

  // パレット 4色
  subBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      multiColor = btn.dataset.color;
      penColor = multiColor;
      updateSubActive();
      hidePalette();
    });
  });

  // パレット外タップで閉じる
  document.addEventListener('pointerdown', (e) => {
    if (!palette || !palette.classList.contains('show')) return;
    if (multiWrap && (multiWrap === e.target || multiWrap.contains(e.target))) return;
    hidePalette();
  }, { passive: true });

  document.querySelectorAll('.btn.size').forEach(btn => {
    btn.addEventListener('click', () => {
      penSize = Number(btn.dataset.size);
      setActive('.btn.size', btn);
    });
  });
  document.getElementById('clearBtn').addEventListener('click', () => {
    const { w, h } = cssSize();
    ctx.save();
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, w, h);
    ctx.restore();
  });

  function getPos(e) {
    const rect = canvas.getBoundingClientRect();
    return {
      x: e.clientX - rect.left,
      y: e.clientY - rect.top
    };
  }

  function startDraw(e) {
    drawing = true;
    activePointerId = (e.pointerId !== undefined) ? e.pointerId : null;

    const p = getPos(e);
    lastX = p.x; lastY = p.y;

    ctx.strokeStyle = penColor;
    ctx.lineWidth = penSize;

    // 点（タップ）でも見えるようにする
    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(lastX + 0.01, lastY + 0.01);
    ctx.stroke();

    try { canvas.setPointerCapture?.(activePointerId); } catch (_) {}
    e.preventDefault();
  }

  function moveDraw(e) {
    if (!drawing) return;
    if (activePointerId !== null && e.pointerId !== undefined && e.pointerId !== activePointerId) return;

    // 速いストロークでも途切れにくくする（中間点をまとめて取得）
    const evs = (typeof e.getCoalescedEvents === 'function') ? e.getCoalescedEvents() : [e];

    ctx.strokeStyle = penColor;
    ctx.lineWidth = penSize;

    for (const ev of evs) {
      const p = getPos(ev);
      ctx.beginPath();
      ctx.moveTo(lastX, lastY);
      ctx.lineTo(p.x, p.y);
      ctx.stroke();
      lastX = p.x; lastY = p.y;
    }
    e.preventDefault();
  }

  function endDraw(e) {
    drawing = false;
    try { if (activePointerId !== null) canvas.releasePointerCapture?.(activePointerId); } catch (_) {}
    activePointerId = null;
    e.preventDefault();
  }

  canvas.addEventListener('pointerdown', startDraw, { passive:false, capture:true });
  canvas.addEventListener('touchstart', (e) => e.preventDefault(), { passive:false, capture:true });
  canvas.addEventListener('pointermove', moveDraw, { passive:false, capture:true });
  // ペン入力の高頻度更新（対応ブラウザのみ）
  canvas.addEventListener('pointerrawupdate', moveDraw, { passive:false, capture:true });
  canvas.addEventListener('pointerup', endDraw, { passive:false, capture:true });
  canvas.addEventListener('pointercancel', endDraw, { passive:false, capture:true });

  // 長押しメニュー抑制
  canvas.addEventListener('contextmenu', (e) => e.preventDefault(), { capture:true });
window.addEventListener('resize', () => resizeCanvas(true));

  requestAnimationFrame(() => resizeCanvas(false));
})();
</script>

<script>
  // オフラインでも起動しやすくするための仕組み（Service Worker）
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./service-worker.js').catch(() => {
  // iPad: テキスト選択が発生したら即解除
  document.addEventListener('selectionchange', () => {
    const sel = document.getSelection?.();
    if (sel && sel.type === 'Range') sel.removeAllRanges();
  });
  // ピンチ/回転などのジェスチャー抑制
  document.addEventListener('gesturestart', (e) => e.preventDefault(), { passive:false });
  document.addEventListener('gesturechange', (e) => e.preventDefault(), { passive:false });
  document.addEventListener('gestureend', (e) => e.preventDefault(), { passive:false });

  document.onselectstart = () => false;
});
    });
  }
</script>

</body>
</html>
